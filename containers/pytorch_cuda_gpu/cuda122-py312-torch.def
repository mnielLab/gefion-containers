Bootstrap: docker
From: nvidia/cuda:12.2.2-runtime-ubuntu22.04

%post
    set -eux

    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime

    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common ca-certificates curl gnupg

    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y --no-install-recommends python3.12

    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12
    ln -sf /usr/bin/python3.12 /usr/local/bin/python

    python -m pip install --no-cache-dir -U pip

    # PyTorch CUDA wheels (cu121 index is the official one commonly used; works with CUDA 12.x + proper host driver)
    python -m pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cu121

    cat > /gpu_check.py <<'PY'
import torch
print("torch:", torch.__version__)
print("cuda available:", torch.cuda.is_available())
if torch.cuda.is_available():
    print("torch cuda:", torch.version.cuda)
    print("device:", torch.cuda.get_device_name(0))
PY

    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    exec python /gpu_check.py
