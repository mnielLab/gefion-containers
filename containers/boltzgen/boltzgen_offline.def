Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PIP_NO_CACHE_DIR=1
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export CUDA_HOME=/usr/local/cuda
    export PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu121
    export HF_HOME=/cache

%post
    set -eux
    
    export DEBIAN_FRONTEND=noninteractive
    export PIP_NO_CACHE_DIR=1
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
    export CUDA_HOME=/usr/local/cuda
    export PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu121
    export HF_HOME=/cache
 
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime

    apt-get update
    apt-get install -y --no-install-recommends software-properties-common curl git ca-certificates
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y --no-install-recommends \
        python3.11 python3.11-dev python3.11-venv \
        build-essential cmake pkg-config \
        libffi-dev libssl-dev libxml2-dev libxslt-dev \
        libgl1 libhdf5-dev libboost-all-dev
    rm -rf /var/lib/apt/lists/*

    # Make python/python3 point to 3.11 (this is just a managed alternative to symlinks)
    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

    # Install pip for this interpreter
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11
    python -m pip install --upgrade pip setuptools setuptools_scm wheel

    # Get BoltzGen source (pin to a commit/tag if you want reproducibility)
    mkdir -p /opt/src
    cd /opt/src
    git clone https://github.com/HannesStark/boltzgen.git
    cd boltzgen

    # Install BoltzGen
    python -m pip install --no-cache-dir -e .

    # Bake weights into image
    mkdir -p "${HF_HOME}"
    boltzgen download all --cache "${HF_HOME}" --force_download
    chmod -R a+rX "${HF_HOME}"
        
    apt-get clean
    rm -rf /var/lib/apt/lists/*


%runscript
    exec boltzgen "$@"

%test
    set -eux
    python --version
    boltzgen --help
    command -v boltz || true

