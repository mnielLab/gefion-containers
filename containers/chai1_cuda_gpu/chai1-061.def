Bootstrap: docker
From: nvidia/cuda:12.2.2-runtime-ubuntu22.04

%environment
    # Use the embedded weights location at runtime.
    # NOTE: /opt in the SIF is read-only, so you should run with an overlay (recommended below).
    export CHAI_DOWNLOADS_DIR=/opt/chai_downloads
    export HF_HUB_OFFLINE=1
    export TRANSFORMERS_OFFLINE=1
    export HF_HUB_DISABLE_TELEMETRY=1

%post
    set -eux

    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/UTC /etc/localtime

    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common ca-certificates curl gnupg

    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y --no-install-recommends python3.12

    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12
    ln -sf /usr/bin/python3.12 /usr/local/bin/python

    python -m pip install --no-cache-dir -U pip setuptools wheel

    # torch (CUDA wheel)
    python -m pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cu121

    # chai
    python -m pip install --no-cache-dir chai_lab==0.6.1

    # %environment isn't active during %post
    export CHAI_DOWNLOADS_DIR=/opt/chai_downloads
    mkdir -p "$CHAI_DOWNLOADS_DIR"

    # ---- Prefetch using Chai's OWN logic (no path guessing) ----
    python - <<'PY'

import os
from pathlib import Path

os.environ["CHAI_DOWNLOADS_DIR"] = "/opt/chai_downloads"
Path(os.environ["CHAI_DOWNLOADS_DIR"]).mkdir(parents=True, exist_ok=True)

# ---- (A) Chai core model weights + conformers ----
from chai_lab.utils.paths import chai1_component, download_if_not_exists, downloads_path 
import chai_lab.utils.paths as paths

for name in ["feature_embedding", "token_embedder", "trunk", "diffusion_module", "confidence_head", "bond_loss_input_proj"]:
    chai1_component(f"{name}.pt")
paths.cached_conformers.get_path()

# ---- (B) Traced ESM2 checkpoint (Chai-hosted) ----
from chai_lab.data.dataset.embeddings import esm as esm_mod

local_esm_path = downloads_path.joinpath("esm/traced_sdpa_esm2_t36_3B_UR50D_fp16.pt")
download_if_not_exists(esm_mod.ESM_URL, local_esm_path)

# ---- Verify key artifacts exist somewhere under CHAI_DOWNLOADS_DIR ----
downloads = Path(os.environ["CHAI_DOWNLOADS_DIR"])
need = {
    "chai pt weights (*.pt)": list(downloads.rglob("*.pt")),
    "conformers (*.apkl)": list(downloads.rglob("*.apkl")),
    "traced esm2 (traced_sdpa_*.pt)": list(downloads.rglob("traced_sdpa_esm2_t36_3B_UR50D_fp16.pt")),
}

missing = [k for k,v in need.items() if not v]
if missing:
    raise SystemExit("Missing after prefetch:\n- " + "\n- ".join(missing))

print("Prefetch OK")
print("Traced ESM2 path:", need["traced esm2 (traced_sdpa_*.pt)"][0])
PY

    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    exec chai-lab "$@"

