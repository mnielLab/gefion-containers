Bootstrap: docker
From: nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu22.04

%labels
    Description Boltz-2 (boltz CLI) offline-capable image with baked model/data cache

%environment
    export DEBIAN_FRONTEND=noninteractive
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1
  
    # Point runtime at the baked cache by default (override if you want)
    export BOLTZ_CACHE=/opt/boltz_cache

    # Torch CUDA wheels index (matches your BoltzGen image pattern)
    export PIP_EXTRA_INDEX_URL=https://download.pytorch.org/whl/cu121

%post
    set -eux

    export DEBIAN_FRONTEND=noninteractive
    export PYTHONDONTWRITEBYTECODE=1
    export PYTHONUNBUFFERED=1

    ln -fs /usr/share/zoneinfo/UTC /etc/localtime

    apt-get update
    apt-get install -y --no-install-recommends \
        software-properties-common curl ca-certificates git \
        libgl1
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update
    apt-get install -y --no-install-recommends \
        python3.11 python3.11-dev python3.11-venv \
        build-essential
    rm -rf /var/lib/apt/lists/*

    update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11
    python -m pip install --upgrade pip setuptools wheel

    # Install boltz (Boltz-2 inference CLI is "boltz predict")
    python -m pip install --no-cache-dir "boltz[cuda]" -U

    # ---- Bake cache artifacts into the image ----
    export BOLTZ_CACHE=/opt/boltz_cache
    mkdir -p "$BOLTZ_CACHE"
    chmod -R a+rX "$BOLTZ_CACHE"

    # Use Boltz's own download code (no Hugging Face hub dependency guessing)
    python - <<'PY'
import os
from pathlib import Path

cache = Path(os.environ.get("BOLTZ_CACHE", "/opt/boltz_cache"))
cache.mkdir(parents=True, exist_ok=True)

# Boltz chooses URLs/filenames internally; we just tell it where the cache is.
import boltz.main as bm

# Boltz-2 weights + mols.tar (function name referenced in repo issues)
if hasattr(bm, "download_boltz2"):
    bm.download_boltz2(cache)
else:
    raise RuntimeError("boltz.main.download_boltz2 not found in this boltz version")

# CCD is needed for ligands/modified residues; many installs download it separately
# (Boltz logs show it downloads ccd.pkl into the cache)
if hasattr(bm, "download_ccd"):
    bm.download_ccd(cache)

print("Baked cache contents:", [p.name for p in cache.iterdir()])
PY

    chmod -R a+rX /opt/boltz_cache
    boltz --help
    apt-get clean || true
    rm -rf /var/lib/apt/lists/* || true

%runscript
    exec boltz "$@"

%test
    set -eux
    python --version
    ls -lah /opt/boltz_cache || true

